<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'/>
    <title>Draw GeoJSON points</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.css' rel='stylesheet'/>
    <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }

    </style>
</head>

<body>

<div id='map'></div>
<script>
    /**
      This function parse the url parameters and return the points as an array of objects.
      Params: Url(String): The url to be parsed.
      Returns: The parameters object.
    */
    function parseUrlParams(url) {
      // get query string from url
      var queryString = url.split('?')[1];
      var points = [];
      var tempObject = {};
      var keyList = [];
      if (queryString) {
        // stuff after # is not part of query string, so get rid of it
        queryString = queryString.split('#')[0];
        // split our query string into its component parts
        var arr = queryString.split('&');
        for (var i = 0; i < arr.length; i++) {
          // separate the keys and the values
          var a = arr[i].split('=');
          // set parameter name and value (use 'null' if empty)
          var paramName = a[0];
          var paramValue = typeof (a[1]) === 'undefined' ? null : a[1];
          if (paramValue == null) {
            console.error("Bad parameters. Parameter value should not be empty. Parsing failed.");
          }
          console.log(paramValue);
          obj = JSON.parse(paramValue);
          tempObject[paramName] = obj;
          keyList.push(paramName);
        }
        if (!("coordinates" in tempObject)) {
          console.error("Bad parameters. Must have coordinates. Parsing failed.");
          return [];
        } else {
          console.log(tempObject);
          console.log(keyList);
          for (var i = 0; i < tempObject["coordinates"].length; i++) {
            var tempPoint = {
              "type": "Feature",
              "geometry": {
                "type": "Point",
                "coordinates": tempObject["coordinates"][i]
              },
              "properties": {}
            };
            for (var j = 0; j < keyList.length; j++) {
              if (keyList[j] != "coordinates") {
                tempPoint["properties"][keyList[j]] = tempObject[keyList[j]][i];;
              }
            }
            points.push(tempPoint);
          }
        }
      }
      return points;
    }
    mapboxgl.accessToken = 'pk.eyJ1Ijoidml2YW5zeHUiLCJhIjoiY2ppeWI1a2hjMDhtNTN3cGo3eDNxMGtjMSJ9.FjXwyZRWC_SGx2L5U74ezA';
    var points = parseUrlParams(decodeURI(window.location.href));
    console.log(points);
    //var points = [];
    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v9',
      center: [103.8497472, 1.291610266],
      zoom: 11
    });

    map.on('load', function () {

      map.addLayer({
        "id": "points",
        "type": "symbol",
        "source": {
          "type": "geojson",
          "data": {
            "type": "FeatureCollection",
            "features": points
          }
        },
        "layout": {
          "icon-image": "{icon}-15",
          "text-field": "{title}",
          "text-font": ["Open Sans Semibold", "Arial Unicode MS Bold"],
          "text-offset": [0, 0.6],
          "text-anchor": "top"
        }
      });
    });

</script>
</body> 
</html>
